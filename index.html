<!DOCTYPE html>
<html lang="en">

<head>
  <title>Poking the bear</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="tw.css">
</head>

<body>
  <div class="flex h-screen w-full flex-col overflow-hidden bg-white text-gray-950 dark:bg-gray-950 dark:text-white">
    <div class="mx-auto min-w-full p-8">

      <!-- Input Section -->
      <form id="message-form">
        <div class="mb-4 flex flex-wrap items-center gap-2 md:justify-between">

          <div class="flex items-center justify-center">
            <label for="imageFile" class="flex flex-row items-center justify-center w-16 h-8 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-gray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600">
                    <svg class="w-3 h-3 mr-2 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                    </svg>
                    <input
                    type="file" 
                    id="imageFile" 
                    accept="image/*" 
                    class="hidden" />
                    <img id="image" src="images/xefig.png" alt="Xefig Logo" class="w-8 h-8" />
            </label>
        </div>

            <input id="name" type="text" placeholder="Name" required
            class="focus:blue-500 w-full rounded-lg border px-2 py-1 sm:w-32" />

          <input id="message" type="text" placeholder="Message" required
            class="focus:blue-500 flex-1 rounded-lg border px-2 py-1" />

          <button id="send-button"
            class="w-full rounded-lg bg-blue-500 px-3 py-1.5 font-bold text-white transition-colors duration-300 hover:bg-blue-600 sm:w-20">Send</button>
        </div>
      </form>

      <div id="result" class="max-h-[calc(100vh-100px)] grow overflow-y-auto space-y-2">
        <!-- Messages Section -->
      </div>
      &nbsp;
    </div>
  </div>

</body>
<script>

  const form = document.getElementById('message-form');
  const nameInput = document.getElementById('name');
  const messageInput = document.getElementById('message');
  const sendButton = document.getElementById('send-button');
  const resultDiv = document.getElementById('result');
  const imageFile = document.getElementById('imageFile');
  const image = document.getElementById('image');
  var group = '';

  function fetchMessages() {
    fetch('https://messages.xefig.workers.dev?g=' + group)
      .then((response) => response.json())
      .then((data) => {
        renderMessages(data);
      })
      .catch((error) => console.error(error));
  }

  function renderMessages(messages) {
    let html = ''; // Initialize container for messages

    // Function to escape HTML special characters
    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')   // Escape &
        .replace(/</g, '&lt;')    // Escape <
        .replace(/>/g, '&gt;')    // Escape >
        .replace(/"/g, '&quot;')  // Escape "
        .replace(/'/g, '&#39;');  // Escape '
    }

    messages.forEach(message => {
      // Escape both name and message
      const escapedName = escapeHtml(message.name);
      const escapedMessage = escapeHtml(message.message);

      html += `
            <div class="flex items-start space-x-2 p-2 bg-gray-100 dark:bg-gray-800 rounded-lg shadow-md">
                <strong>${escapedName}</strong>
                <p>${escapedMessage}</p>
            </div>
        `;
    });

    document.getElementById('result').innerHTML = html;
  }

  async function hash(sourceBytes) {
    const digest = await crypto.subtle.digest("SHA-1", sourceBytes);
    const resultBytes = [...new Uint8Array(digest)];
    return resultBytes.map(x => x.toString(16).padStart(2, '0')).join("");
}

  const sendMessage = () => {
    const name = nameInput.value.trim();
    const message = messageInput.value.trim();

    if (name && message) {
      localStorage.setItem('name', name); // Save the username in localStorage

      const jsonData = JSON.stringify({ name, message });
      fetch('https://messages.xefig.workers.dev?g=' + group, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: jsonData,
      })
        .then((response) => response.json())
        .then((data) => {
          renderMessages(data);
        })
        .catch((error) => console.error(error));

      messageInput.value = '';
    }
  };

  function setGroup() {
    var image = document.getElementById("image");

    const canvas = document.createElement('canvas');
    var ctx = canvas.getContext("2d", { willReadFrequently: true });

    // Set canvas dimensions matching the image
    canvas.width = image.width;
    canvas.height = image.height;

    // Draw the image on the canvas
    ctx.drawImage(image, 0, 0);

    // Get the image data (returns an ImageData object)
    var imgData = ctx.getImageData(0, 0, image.width, image.height);

    hash(imgData.data)
      .then((hash) => group = hash)
      .then(() => fetchMessages() );

  }

  document.addEventListener('DOMContentLoaded', async function () {
    try {
      const savedUsername = localStorage.getItem('name'); // Retrieve saved username

      if (savedUsername) {
        document.getElementById('name').value = savedUsername; // Pre-fill the username input
      }

      setGroup();

    } catch (error) {
      console.error('Error:', error);
      document.getElementById('result').innerHTML = `
            <p class="text-red-500">Failed to load messages. Please try again later.</p>
        `;
    }
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    sendMessage();
  });

  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  sendButton.addEventListener('click', () => {
    sendMessage();
  });

  imageFile.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) {
        var reader = new FileReader();
  
        reader.onload = function (e) {
          var image = document.getElementById("image");
          image.src = e.target.result;

          setGroup();
        };

        reader.readAsDataURL(e.target.files[0]);
      }
  });


</script>

</html>